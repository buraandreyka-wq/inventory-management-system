<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head('Товары')}"></head>
<body>
<div th:replace="~{fragments/layout :: navbar}"></div>
<div th:replace="~{fragments/layout :: alerts}"></div>

<main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Товары</h1>
        <a class="btn btn-primary" th:href="@{/products/new}" sec:authorize="hasAnyRole('MANAGER','ADMIN')">+ Добавить</a>
    </div>

    <form class="row g-2 mb-3" method="get" th:action="@{/products}">
        <div class="col-lg-6">
            <input class="form-control" type="search" name="q" th:value="${q}" placeholder="Поиск по названию или SKU"/>
        </div>
        <div class="col-lg-4">
            <select class="form-select" name="warehouseId">
                <option th:selected="${warehouseId == null}" value="">Все склады (суммарно)</option>
                <option th:each="w : ${warehouses}"
                        th:value="${w.id}"
                        th:text="${w.name}"
                        th:selected="${warehouseId != null and warehouseId == w.id}"></option>
            </select>
        </div>
        <div class="col-lg-2 d-flex gap-2">
            <button class="btn btn-outline-primary w-100" type="submit">Найти</button>
            <a class="btn btn-outline-secondary" th:href="@{/products}">Сброс</a>
        </div>
    </form>

    <div class="card">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead>
                <tr>
                    <th style="width: 90px">ID</th>
                    <th style="width: 140px">SKU</th>
                    <th>Название</th>
                    <th style="width: 180px">Категория</th>
                    <th style="width: 120px">Ед.</th>
                    <th style="width: 120px">Мин.</th>
                    <th style="width: 120px">Цена</th>
                    <th style="width: 120px">Остаток</th>
                    <th style="width: 90px">Активен</th>
                    <th style="width: 220px"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${productsPage.totalElements == 0}">
                    <td colspan="10" class="text-muted">Ничего не найдено</td>
                </tr>
                <tr th:each="p : ${productsPage.content}">
                    <td th:text="${p.id}">1</td>
                    <td><code th:text="${p.sku}">SKU</code></td>
                    <td>
                        <div class="fw-semibold" th:text="${p.name}">Name</div>
                        <div class="text-muted small" th:text="${p.description}">desc</div>
                    </td>
                    <td th:text="${p.category != null ? p.category.name : '-'}">-</td>
                    <td th:text="${p.unit}">шт</td>
                    <td th:text="${p.minStock}">0</td>
                    <td th:text="${#numbers.formatDecimal(p.price, 1, 'COMMA', 2, 'POINT')}">0.00</td>
                    <td>
                        <span class="badge" th:classappend="${qtyByProductId[p.id] < p.minStock ? ' text-bg-warning' : ' text-bg-light'}"
                              th:text="${qtyByProductId[p.id]}">0</span>
                    </td>
                    <td>
                        <span class="badge" th:classappend="${p.active ? ' text-bg-success' : ' text-bg-secondary'}" th:text="${p.active ? 'Да' : 'Нет'}">Да</span>
                    </td>
                    <td class="text-end">
                        <a class="btn btn-outline-secondary btn-sm" th:href="@{|/products/${p.id}/edit|}" sec:authorize="hasAnyRole('MANAGER','ADMIN')">Изменить</a>
                        <form class="d-inline" th:action="@{|/products/${p.id}/delete|}" method="post" sec:authorize="hasRole('ADMIN')">
                            <button class="btn btn-outline-danger btn-sm" type="submit" data-confirm="Удалить товар?">Удалить</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <nav class="mt-3" th:if="${productsPage.totalPages > 1}">
        <ul class="pagination">
            <li class="page-item" th:classappend="${productsPage.first ? ' disabled' : ''}">
                <a class="page-link" th:href="@{/products(page=${productsPage.number-1}, q=${q}, warehouseId=${warehouseId})}">Назад</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(0, productsPage.totalPages-1)}" th:classappend="${i == productsPage.number ? ' active' : ''}">
                <a class="page-link" th:text="${i+1}" th:href="@{/products(page=${i}, q=${q}, warehouseId=${warehouseId})}">1</a>
            </li>
            <li class="page-item" th:classappend="${productsPage.last ? ' disabled' : ''}">
                <a class="page-link" th:href="@{/products(page=${productsPage.number+1}, q=${q}, warehouseId=${warehouseId})}">Вперёд</a>
            </li>
        </ul>
    </nav>
</main>

<div th:replace="~{fragments/layout :: scripts}"></div>
</body>
</html>
